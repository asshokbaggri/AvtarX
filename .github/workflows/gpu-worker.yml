name: GPU Worker Deploy

on:
  push:
    paths:
      - "backend/**"
      - "devops/docker/gpu.dockerfile"
      - ".github/workflows/gpu-worker.yml"

jobs:
  deploy-gpu:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Build GPU Image
        run: docker build -t avtarx-gpu -f devops/docker/gpu.dockerfile .

      - name: Push to RunPod Registry
        run: |
          docker login -u "$RP_USERNAME" -p "$RP_PASSWORD" registry.runpod.io
          docker tag avtarx-gpu registry.runpod.io/$RP_USERNAME/avtarx-gpu
          docker push registry.runpod.io/$RP_USERNAME/avtarx-gpu

      - name: Trigger GPU Worker Restart
        run: curl -X POST "$RP_DEPLOY_HOOK"
